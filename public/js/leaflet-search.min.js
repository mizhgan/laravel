//Original: 25713
//Compressed: 12953
(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:1,initial:!0,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,autoCollapse:!1,autoCollapseTime:1200,animateLocation:!0,circleLocation:!0,markerLocation:!1,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft"},initialize:function(a){L.Util.setOptions(this,
a||{});this._inputMinSize=this.options.text?this.options.text.length:10;this._layer=this.options.layer||new L.LayerGroup;this._filterJSON=this.options.filterJSON||this._defaultFilterJSON;this._autoTypeTmp=this.options.autoType;this._countertips=0;this._recordsCache={}},onAdd:function(a){this._map=a;this._container=L.DomUtil.create("div","leaflet-control-search");this._input=this._createInput(this.options.text,"search-input");this._tooltip=this._createTooltip("search-tooltip");this._cancel=this._createCancel(this.options.textCancel,
"search-cancel");this._button=this._createButton(this.options.text,"search-button");this._alert=this._createAlert("search-alert");if(this.options.circleLocation||this.options.markerLocation)this._markerLoc=new f([0,0],{marker:this.options.markerLocation});this.setLayer(this._layer);this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width");return this._container},onRemove:function(a){this._recordsCache={}},setLayer:function(a){this._layer=a;this._layer.addTo(this._map);this._markerLoc&&
this._layer.addLayer(this._markerLoc);return this},showAlert:function(a){a=a||this.options.textErr;this._alert.style.display="block";this._alert.innerHTML=a;clearTimeout(this.timerAlert);var b=this;this.timerAlert=setTimeout(function(){b.hideAlert()},this.options.autoCollapseTime);return this},hideAlert:function(){this._alert.style.display="none";return this},cancel:function(){this._input.value="";this._handleKeypress({keyCode:8});this._input.size=this._inputMinSize;this._input.focus();this._cancel.style.display=
"none";return this},expand:function(){this._input.style.display="block";L.DomUtil.addClass(this._container,"search-exp");this._input.focus();this._map.on("dragstart",this.collapse,this);return this},collapse:function(){this._hideTooltip();this.cancel();this._alert.style.display="none";this._input.style.display="none";this._input.blur();this._cancel.style.display="none";L.DomUtil.removeClass(this._container,"search-exp");this._map.off("dragstart",this.collapse,this);this.fire("search_collapsed");return this},
collapseDelayed:function(){var a=this;clearTimeout(this.timerCollapse);this.timerCollapse=setTimeout(function(){a.collapse()},this.options.autoCollapseTime);return this},collapseDelayedStop:function(){clearTimeout(this.timerCollapse);return this},_createAlert:function(a){a=L.DomUtil.create("div",a,this._container);a.style.display="none";L.DomEvent.on(a,"click",L.DomEvent.stop,this).on(a,"click",this.hideAlert,this);return a},_createInput:function(a,b){var c=L.DomUtil.create("input",b,this._container);
c.type="text";c.size=this._inputMinSize;c.value="";c.autocomplete="off";c.placeholder=a;c.style.display="none";L.DomEvent.disableClickPropagation(c).on(c,"keyup",this._handleKeypress,this).on(c,"keydown",this._handleAutoresize,this).on(c,"blur",this.collapseDelayed,this).on(c,"focus",this.collapseDelayedStop,this);return c},_createCancel:function(a,b){var c=L.DomUtil.create("a",b,this._container);c.href="#";c.title=a;c.style.display="none";c.innerHTML="<span>&otimes;</span>";L.DomEvent.on(c,"click",
L.DomEvent.stop,this).on(c,"click",this.cancel,this);return c},_createButton:function(a,b){var c=L.DomUtil.create("a",b,this._container);c.href="#";c.title=a;L.DomEvent.on(c,"click",L.DomEvent.stop,this).on(c,"click",this._handleSubmit,this).on(c,"focus",this.collapseDelayedStop,this).on(c,"blur",this.collapseDelayed,this);return c},_createTooltip:function(a){a=L.DomUtil.create("div",a,this._container);a.style.display="none";var b=this;L.DomEvent.disableClickPropagation(a).on(a,"blur",this.collapseDelayed,
this).on(a,"mousewheel",function(a){b.collapseDelayedStop();L.DomEvent.stopPropagation(a)},this).on(a,"mouseover",function(a){b.collapseDelayedStop()},this);return a},_createTip:function(a,b){var c;if(this.options.callTip){if(c=this.options.callTip(a,b),"string"===typeof c){var d=L.DomUtil.create("div");d.innerHTML=c;c=d.firstChild}}else c=L.DomUtil.create("a",""),c.href="#",c.innerHTML=a;L.DomUtil.addClass(c,"search-tip");c._text=a;L.DomEvent.disableClickPropagation(c).on(c,"click",L.DomEvent.stop,
this).on(c,"click",function(c){this._input.value=a;this._handleAutoresize();this._input.focus();this._hideTooltip();this.options.tipAutoSubmit&&this._handleSubmit()},this);return c},_filterRecords:function(a){a=a.replace(RegExp("^[.]$|[[]|()*]","g"),"");a=RegExp((this.options.initial?"^":"")+a,"i");var b={},c;for(c in this._recordsCache)a.test(c)&&(b[c]=this._recordsCache[c]);return b},showTooltip:function(){var a,b;this._countertips=0;a=this.options.layer?this._filterRecords(this._input.value):this._recordsCache;
this._tooltip.innerHTML="";this._tooltip.currentSelection=-1;for(var c in a){if(++this._countertips==this.options.tooltipLimit)break;b=this._createTip(c,a[c]);this._tooltip.appendChild(b)}0<this._countertips?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip();this._tooltip.scrollTop=0;return this._countertips},_hideTooltip:function(){this._tooltip.style.display="none";this._tooltip.innerHTML="";return 0},_defaultFilterJSON:function(a){var b=
{},c=this.options.propertyName,d=this.options.propertyLoc;if(L.Util.isArray(d))for(var e in a)b[a[e][c]]=L.latLng(a[e][d[0]],a[e][d[1]]);else for(e in a)b[a[e][c]]=L.latLng(a[e][d]);return b},_recordsFromJsonp:function(a,b){var c=this;L.Control.Search.callJsonp=function(a){a=c._filterJSON(a);b(a)};var d=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),e=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:a});d.type="text/javascript";
d.src=e;return this},_recordsFromAjax:function(a,b){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(a){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(c){throw Error("XMLHttpRequest is not supported");}}});var c=new XMLHttpRequest,d=L.Util.template(this.options.url,{s:a}),e={};c.open("GET",d);var f=this;c.onreadystatechange=function(){if(4===c.readyState&&200===c.status){e=window.JSON?JSON.parse(c.responseText):
eval("("+c.responseText+")");var a=f._filterJSON(e);b(a)}};c.send();return this},_recordsFromLayer:function(){var a={},b=this.options.propertyName,c;this._layer.eachLayer(function(d){d instanceof f||(d instanceof L.Marker?d.options.hasOwnProperty(b)?(c=d.getLatLng(),c.layer=d,a[d.options[b]]=c):console.log("propertyName '"+b+"' not found in marker",d):d.hasOwnProperty("feature")&&(d.feature.properties.hasOwnProperty(b)?(c=d.getBounds().getCenter(),c.layer=d,a[d.feature.properties[b]]=c):console.log("propertyName '"+
b+"' not found in feature",d)))},this);return a},_autoType:function(){var a=this._input.value.length,b=this._tooltip.firstChild._text,c=b.length;0==b.indexOf(this._input.value)&&(this._input.value=b,this._handleAutoresize(),this._input.createTextRange?(b=this._input.createTextRange(),b.collapse(!0),b.moveStart("character",a),b.moveEnd("character",c),b.select()):this._input.setSelectionRange?this._input.setSelectionRange(a,c):this._input.selectionStart&&(this._input.selectionStart=a,this._input.selectionEnd=
c))},_hideAutoType:function(){var a;if((a=this._input.selection)&&a.empty)a.empty();else if(this._input.createTextRange){a=this._input.createTextRange();a.collapse(!0);var b=this._input.value.length;a.moveStart("character",b);a.moveEnd("character",b);a.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(a){switch(a.keyCode){case 27:this.collapse();break;case 13:1==this._countertips&&this._handleArrowSelect(1);
this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;default:if(this._cancel.style.display=this._input.value.length?"block":"none",this._input.value.length>=this.options.minLength){var b=this;clearTimeout(this.timerKeypress);this.timerKeypress=setTimeout(function(){b._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var a=
this._input.value;L.DomUtil.addClass(this._container,"search-load");if(this.options.callData){var b=this;this.options.callData(a,function(a){b._recordsCache=b._filterJSON(a);b.showTooltip();L.DomUtil.removeClass(b._container,"search-load")})}else this.options.url?this.options.jsonpParam?(b=this,this._recordsFromJsonp(a,function(a){b._recordsCache=a;b.showTooltip();L.DomUtil.removeClass(b._container,"search-load")})):(b=this,this._recordsFromAjax(a,function(a){b._recordsCache=a;b.showTooltip();L.DomUtil.removeClass(b._container,
"search-load")})):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(a){var b=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<b.length;i++)L.DomUtil.removeClass(b[i],
"search-tip-select");1==a&&this._tooltip.currentSelection>=b.length-1?L.DomUtil.addClass(b[this._tooltip.currentSelection],"search-tip-select"):-1==a&&0>=this._tooltip.currentSelection?this._tooltip.currentSelection=-1:"none"!=this._tooltip.style.display&&(this._tooltip.currentSelection+=a,L.DomUtil.addClass(b[this._tooltip.currentSelection],"search-tip-select"),this._input.value=b[this._tooltip.currentSelection]._text,a=b[this._tooltip.currentSelection].offsetTop,a+b[this._tooltip.currentSelection].clientHeight>=
this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=a-this._tooltip.clientHeight+b[this._tooltip.currentSelection].clientHeight:a<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=a))},_handleSubmit:function(){this._hideAutoType();this.hideAlert();this._hideTooltip();if("none"==this._input.style.display)this.expand();else if(""==this._input.value)this.collapse();else{var a=this._getLocation(this._input.value);!1===a?this.showAlert():(this.showLocation(a,this._input.value),
this.fire("search_locationfound",{latlng:a,text:this._input.value,layer:a.layer?a.layer:null}))}},_getLocation:function(a){return this._recordsCache.hasOwnProperty(a)?this._recordsCache[a]:!1},showLocation:function(a,b){this.options.zoom?this._map.setView(a,this.options.zoom):this._map.panTo(a);this._markerLoc&&(this._markerLoc.setLatLng(a),this._markerLoc.setTitle(b),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate());this.options.autoCollapse&&this.collapse();return this}});
var f=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1,title:"",marker:!1},initialize:function(a,b){L.setOptions(this,b);L.Marker.prototype.initialize.call(this,a,b);this._circleLoc=new L.CircleMarker(a,this.options)},onAdd:function(a){L.Marker.prototype.onAdd.call(this,a);a.addLayer(this._circleLoc);this.hide()},onRemove:function(a){L.Marker.prototype.onRemove.call(this,a);a.removeLayer(this._circleLoc)},setLatLng:function(a){L.Marker.prototype.setLatLng.call(this,
a);this._circleLoc.setLatLng(a);return this},setTitle:function(a){a=a||"";this.options.title=a;this._icon&&(this._icon.title=a);return this},show:function(){this.options.marker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block"));this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke});return this},hide:function(){this._icon&&(this._icon.style.display="none");this._shadow&&(this._shadow.style.display="none");this._circleLoc&&
this._circleLoc.setStyle({fill:!1,stroke:!1});return this},animate:function(){var a=this._circleLoc,b=parseInt(a._radius/10),c=this.options.radius,d=2.5*a._radius,e=0;a._timerAnimLoc=setInterval(function(){e+=0.5;b+=e;d-=b;a.setRadius(d);d<c&&(clearInterval(a._timerAnimLoc),a.setRadius(c))},200);return this}});L.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=L.control.search(this.options.searchControl),this.addControl(this.searchControl))});L.control.search=function(a){return new L.Control.Search(a)}}).call(this); 
